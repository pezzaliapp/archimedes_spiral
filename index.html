<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Archimedes Spiral — PWA Core (Qualità)</title>
<meta name="theme-color" content="#0b1022">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{--bg:#0b1022;--ink:#eaf1ff;--muted:#93a4cc}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 50% -20%,#172042,var(--bg));color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;display:flex;flex-direction:column}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #1c2550;background:#0e1533cc;backdrop-filter:blur(6px)}
  main{flex:1 1 auto;display:flex;flex-direction:column;gap:8px;padding:8px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .controls label{background:#0f1636;border:1px solid #1c2550;border-radius:10px;padding:6px 8px;color:var(--muted);display:flex;align-items:center;gap:6px}
  .controls button{background:transparent;color:var(--ink);border:1px solid #2a366d;border-radius:10px;padding:6px 10px;cursor:pointer}
  .stage{flex:1 1 auto;border:1px solid #1c2550;border-radius:14px;overflow:hidden;background:#0b1130;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  canvas{display:block;width:100%;height:100%}
  footer{padding:8px;text-align:center;color:var(--muted);border-top:1px solid #1c2550}
</style>
</head>
<body>

  <header>
    <strong>Archimedes Spiral — PWA Core (Qualità)</strong>
    <span style="opacity:.7">Monofile senza cache</span>
  </header>
  <main>
    <div class="controls">
      <label>Modo
        <select id="mode">
          <option value="2d" selected>2D</option>
          <option value="3d">3D (elica)</option>
        </select>
      </label>
      <label>Giri <input id="turns" type="number" min="1" max="50" step="1" value="12" style="width:72px"></label>
      <label>Passo b <input id="b" type="number" min="1" max="30" step="0.5" value="6" style="width:72px"></label>
      <label>Spessore <input id="lw" type="number" min="1" max="5" step="1" value="2" style="width:64px"></label>
      <label>Colore <input id="color" type="color" value="#2dd4bf"></label>
      <label>Gradiente
        <select id="gradientMode">
          <option value="none" selected>Nessuno</option>
          <option value="depth">Profondità</option>
          <option value="radius">Distanza</option>
          <option value="angle">Angolo</option>
        </select>
      </label>
      <label><input id="points" type="checkbox"> Punti</label>
      <label><input id="animate" type="checkbox" checked> Anima</label>
      <label class="only3d" style="display:none">z/giro <input id="zpt" type="number" min="-400" max="400" step="1" value="140" style="width:72px"></label>
      <label class="only3d" style="display:none">FOV <input id="fov" type="number" min="200" max="1400" step="10" value="700" style="width:72px"></label>
      <label class="only3d" style="display:none">Rot Y (°/s) <input id="ry" type="number" min="-180" max="180" step="1" value="20" style="width:72px"></label>

      <label>Qualità
        <select id="quality">
          <option value="low">Bassa</option>
          <option value="med" selected>Media</option>
          <option value="high">Alta</option>
        </select>
      </label>
      <button id="btnAutoQuality">Qualità Auto</button>
    </div>

    <div class="stage"><canvas id="cv"></canvas></div>
  </main>
  <footer>© 2025 — versione qualità · vQ1</footer>

<script>
(function(){
  'use strict';
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const $ = id => document.getElementById(id);

  const mode = $('mode'), turns = $('turns'), bEl = $('b'), lw = $('lw'),
        color = $('color'), points = $('points'), animate = $('animate'),
        zpt = $('zpt'), fovEl = $('fov'), ry = $('ry'),
        quality = $('quality'), btnAutoQuality = $('btnAutoQuality');
  const only3d = Array.from(document.querySelectorAll('.only3d'));

  function resize(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = cv.clientWidth, h = cv.clientHeight;
    cv.width = Math.max(1, Math.floor(w * dpr));
    cv.height = Math.max(1, Math.floor(h * dpr));
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', ()=>{ resize(); compute(); draw(0); });

  // Geometry
  let P2 = [], P3 = [];
  function compute(){
    const b = parseFloat(bEl.value);
    const tMax = parseInt(turns.value,10) * Math.PI * 2;
    const MAX = quality.value==='low'?6000:(quality.value==='high'?24000:12000);
    const step = Math.max(0.003, tMax / MAX);
    P2 = []; P3 = [];
    for(let t=0; t<=tMax; t+=step){
      const r = b * t;
      const x = r*Math.cos(t), y = -r*Math.sin(t);
      P2.push({x,y,r,t});
      const z = (parseFloat(zpt.value) * t)/(Math.PI*2);
      P3.push({x,y,z,r,t});
    }
  }

  function project3D(x,y,z,fov,w,h){
    const dz = z + fov; const px = (x*fov)/dz, py = (y*fov)/dz;
    return {x:px + w/2, y:py + h/2, d:dz};
  }
  function rotateY(x,y,z,ang){
    const c=Math.cos(ang), s=Math.sin(ang);
    return {x: x*c + z*s, y, z: -x*s + z*c};
  }

  function draw(t){
    const w = cv.width/(window.devicePixelRatio||1);
    const h = cv.height/(window.devicePixelRatio||1);
    ctx.clearRect(0,0,w,h);
    ctx.lineWidth = Math.max(1, parseInt(lw.value,10));
    const asPts = !!points.checked;
    const col = color.value;

    if (mode.value === '2d'){
      const rot = t*0.6;
      ctx.save(); ctx.translate(w/2, h/2); ctx.rotate(rot);
      ctx.strokeStyle = col; ctx.fillStyle = col;
      if (!asPts) ctx.beginPath();
      for(let i=0;i<P2.length;i++){
        const p = P2[i]; if (asPts) ctx.fillRect(p.x,p.y,ctx.lineWidth,ctx.lineWidth);
        else (i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
      }
      if (!asPts) ctx.stroke();
      ctx.restore(); return;
    }

    const fov = parseFloat(fovEl.value);
    const angY = (t * (parseFloat(ry.value)*Math.PI/180));
    let prev = null;
    ctx.strokeStyle = col; ctx.fillStyle = col;
    for(let i=0;i<P3.length;i++){
      const b = P3[i];
      const rY = rotateY(b.x, b.y, b.z, angY);
      const p = project3D(rY.x, rY.y, rY.z, fov, w, h);
      if (asPts) ctx.fillRect(p.x, p.y, ctx.lineWidth, ctx.lineWidth);
      else if (prev){ ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(p.x,p.y); ctx.stroke(); }
      prev = p;
    }
  }

  function sync3dUI(){ const is3d = mode.value === '3d'; only3d.forEach(el => el.style.display = is3d ? '' : 'none'); }
  [mode,turns,bEl,lw,color,points,animate,zpt,fovEl,ry,quality].forEach(el=> el.addEventListener('input', ()=>{ sync3dUI(); compute(); }));

  // Auto Quality test (~1s)
  function autoQuality(){
    const testDuration = 1000; let frames = 0;
    const prev = animate.checked; animate.checked = true;
    const start = performance.now();
    function testTick(now){
      frames++; draw((now - start)/1000);
      if (now - start < testDuration){ requestAnimationFrame(testTick); }
      else {
        const fps = frames * 1000 / (now - start);
        let level = 'med'; if (fps>=55) level='high'; else if (fps>=28) level='med'; else level='low';
        quality.value = level; compute(); draw(0);
        if (!prev) animate.checked = false;
        alert('FPS stimato: ' + fps.toFixed(0) + ' → Qualità: ' + (level=='high'?'Alta':level=='med'?'Media':'Bassa'));
      }
    }
    requestAnimationFrame(testTick);
  }
  btnAutoQuality.addEventListener('click', autoQuality);

  // Loop
  function tick(now){ if (!animate.checked){ draw(0); return; } const t=(now-startTime)/1000; draw(t); requestAnimationFrame(tick); }
  let startTime = performance.now();

  // Init
  sync3dUI(); resize(); compute(); startTime = performance.now(); requestAnimationFrame(tick);
})();</script>

<script src="app.js"></script>
</body>
</html>
